(()=>{var __webpack_modules__={457:(e,t,a)=>{"use strict";a.d(t,{sY:()=>n,oj:()=>l,D8:()=>c});var r=a(4);const s=__dirname+"/../../";const _={executablePath:"C:/Program Files (x86)/Google/Chrome/Application/chrome.exe",timeout:15e3,ignoreHTTPSErrors:true,devtools:false,headless:true};let i={path:s+"storage/imgs/"+r.Z.uuid()+".png",type:"png",quality:100,fullPage:true,args:["–-disable-gpu","–-disable-dev-shm-usage","–-disable-setuid-sandbox","–-no-first-run","–-no-sandbox","–-no-zygote","–-single-process"]};const n={bright:true,absolute:false,date:false,console:true,debug:true,store:true,log_path:"/tmp/comic"};const l="https://dfe6457f6176454d8c27edc2f8752741@o481346.ingest.sentry.io/5584132";const o={access_key:"asdasdad",secret_key:"",bucket_name:"",cdn_host:""};const c=7070},322:(e,t,a)=>{"use strict";a.d(t,{r8:()=>r,SC:()=>s});const r={UNKNOWN:0,GU_FENG:1,QI_MAN_WU:2,LIU_MAN_HUA:3};const s={DELETED:0,INVALID:50,OFFLINE:100,ONLINE:200};const _={}},420:(e,t,a)=>{"use strict";a.d(t,{Z:()=>s});var r=a(927);class BaseService{static get_fake_ua(){return r.getRandom()}static delay_ms(e){return new Promise((t=>setTimeout((()=>t()),e)))}}class Base extends BaseService{}const s=Base},971:(__unused_webpack_module,__webpack_exports__,__nccwpck_require__)=>{"use strict";__nccwpck_require__.d(__webpack_exports__,{Z:()=>GuFengService});var _Base__WEBPACK_IMPORTED_MODULE_0__=__nccwpck_require__(420);var _tools_Log__WEBPACK_IMPORTED_MODULE_1__=__nccwpck_require__(80);var _models_CurlAvatar_Supplier_Enum__WEBPACK_IMPORTED_MODULE_2__=__nccwpck_require__(322);var _tools_UserAgentTool__WEBPACK_IMPORTED_MODULE_3__=__nccwpck_require__(833);const fetch=__nccwpck_require__(464);const cheerio=__nccwpck_require__(603);class GuFengService extends _Base__WEBPACK_IMPORTED_MODULE_0__.Z{static async get_base_info(e,t){_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,`开始拉取 source_id ${t} 基本信息`);let a=`https://www.gufengmh8.com/manhua/${t}/`;let r={headers:{"User-Agent":_tools_UserAgentTool__WEBPACK_IMPORTED_MODULE_3__.Z.fake_one()},timeout:3e3};return fetch(a,r).then((e=>e.text())).then((a=>{const r=cheerio.load(a);let s=r(".book-title").find("span").text();let _=r(".book-cover").find("img").attr("src");let i=r("#intro-all").text().trim("");_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,"数据如下",{name:s,pic:_,intro:i});_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,`拉取结束 source_id ${t} 基本信息`);return{name:s,pic:_,intro:i}}))}static async get_chapter_list(e,t,a){_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,`开始拉取 source_id ${t} 基本信息`);let r=`https://www.gufengmh8.com/manhua/${t}/`;let s={headers:{"User-Agent":_tools_UserAgentTool__WEBPACK_IMPORTED_MODULE_3__.Z.fake_one()},timeout:3e3};return fetch(r,s).then((e=>e.text())).then((r=>{let s=[];const _=cheerio.load(r);let i=_(".comic-chapters");let n=i.length;if(i===undefined||n===0){_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxError(e,"爬取章节TAB失败");return s}for(let t=0;t<n;t++){let r=i.eq(t);let _=r.find(".caption span").text().trim();if(a==_){let t=r.find("li");let a=t.length;if(t===undefined||a===0){_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxError(e,"爬取章节列表失败");return s}for(let e=0;e<a;e++){let a=t.eq(e);let r=a.find("a").attr("href");r=`https://www.gufengmh8.com${r}`;let _=a.find("span").text();let i=e+1;let n={link:r,name:_,sequence:i};s.push(n)}}}_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,`拉取结束 source_id ${t} 总计章节数 ${s.length}`);return s}))}static async get_image_list(ctx,target_url){let image_list=[];_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(ctx,`开始拉取 ${target_url} 图片列表`);let options={headers:{"User-Agent":_tools_UserAgentTool__WEBPACK_IMPORTED_MODULE_3__.Z.fake_one()},timeout:3e3};return fetch(target_url,options).then((e=>e.text())).then((html=>{let srcpt_tpls=html.match(/var siteName = "";(.*?)var prevChapterData/);let tpl=srcpt_tpls[1];let func_string=`(function tmp_func(data){\n                  let output = {}; ${tpl}\n                  output = {chapterImages,chapterPath,pageImage,}\n                  return output;\n                })`;let func=eval(func_string);let{chapterImages:chapterImages,chapterPath:chapterPath,pageImage:pageImage}=func();let matches=pageImage.match(/^.*?\/\/(.*?)\//);let img_host=matches[0];let img_path=chapterPath;let lenImg=chapterImages.length;for(let e=0;e<lenImg;e++){let t=img_host+img_path+chapterImages[e];image_list.push(t)}_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(ctx,`拉取结束 target_url ${target_url} 总计图片数 ${image_list.length}`);return image_list}))}}},4:(e,t,a)=>{"use strict";a.d(t,{Z:()=>General});class General{static uuid(){let e=[];let t="0123456789abcdef";for(let a=0;a<36;a++){e[a]=t.substr(Math.floor(Math.random()*16),1)}e[14]="4";e[19]=t.substr(e[19]&3|8,1);e[8]=e[13]=e[18]=e[23]="-";let a=e.join("");return a}static format_time(e,t){t=t===undefined?0:t;t=parseInt(t)*1e3;let a=t===0?new Date:new Date(t);const add_zero=e=>{if(e<=9){return"0"+e}else{return""+e+""}};let r,s,_,i,n,l;r=a.getFullYear();s=add_zero(a.getMonth()+1);_=add_zero(a.getDate());i=add_zero(a.getHours());n=add_zero(a.getMinutes());l=add_zero(a.getSeconds());e=e.replace("Y",r);e=e.replace("m",s);e=e.replace("d",_);e=e.replace("h",i);e=e.replace("i",n);e=e.replace("s",l);return e}static mt_rand(e,t){return parseInt(Math.random()*(t-e+1)+e,10)}static is_json(e){if(typeof e=="string"){try{JSON.parse(e);return true}catch(e){return false}}return false}static get_data_with_default(e,t){if(typeof e==="undefined"||e==null){return t}return e}}},80:(e,t,a)=>{"use strict";a.d(t,{Z:()=>c});const r=require("fs");var s=a.n(r);var _=a(457);var i=a(4);var n=a(506);var l=a.n(n);const o=new(l())(_.sY);o.storeHandler=e=>{let t=[];for(let a in e){switch(a){case"date":let r=i.Z.format_time("Y-m-d h:i:s");e[a]=`[${r}]`;t.push(e[a]);break;default:break}}t.push(" ");const a=i.Z.format_time("Y-m-d")+".log";const r=_.sY.log_path+"/"+a;s().appendFileSync(r,t.concat(e.logs).join("")+"\n")};o.ctxInfo=(e,t)=>{o.info(e.get_trace_id()+"  "+t)};o.ctxError=(e,t)=>{o.error(e.get_trace_id()+"  "+t)};o.ctxWarn=(e,t)=>{o.warn(e.get_trace_id()+"  "+t)};const c=o},833:(e,t,a)=>{"use strict";a.d(t,{Z:()=>UserAgentTool});var r=a(4);const s=["Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.12) Gecko/20070731 Ubuntu/dapper-security Firefox/1.5.0.12","Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; Acoo Browser; SLCC1; .NET CLR 2.0.50727; Media Center PC 5.0; .NET CLR 3.0.04506)","Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.56 Safari/535.11","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_3) AppleWebKit/535.20 (KHTML, like Gecko) Chrome/19.0.1036.7 Safari/535.20","Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6","Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.71 Safari/537.1 LBBROWSER","Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 2.0.50727; Media Center PC 6.0) ,Lynx/2.8.5rel.1 libwww-FM/2.14 SSL-MM/1.4.1 GNUTLS/1.2.9","Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)","Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; QQBrowser/7.0.3698.400)","Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E)","Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:2.0b13pre) Gecko/20110307 Firefox/4.0b13pre","Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; fr) Presto/2.9.168 Version/11.52","Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.12) Gecko/20070731 Ubuntu/dapper-security Firefox/1.5.0.12","Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; LBBROWSER)","Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6","Mozilla/5.0 (X11; U; Linux; en-US) AppleWebKit/527+ (KHTML, like Gecko, Safari/419.3) Arora/0.6","Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; QQBrowser/7.0.3698.400)","Opera/9.25 (Windows NT 5.1; U; en), Lynx/2.8.5rel.1 libwww-FM/2.14 SSL-MM/1.4.1 GNUTLS/1.2.9","Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"];class UserAgentTool{static fake_one(){let e=0;let t=s.length-1;let a=r.Z.mt_rand(e,t);return s[a]}}},403:module=>{module.exports=eval("require")("@sentry/node")},889:module=>{module.exports=eval("require")("@sentry/tracing")},427:module=>{module.exports=eval("require")("amqplib")},603:module=>{module.exports=eval("require")("cheerio")},975:module=>{module.exports=eval("require")("koa")},180:module=>{module.exports=eval("require")("koa-bodyparser")},243:module=>{module.exports=eval("require")("koa-router")},62:module=>{module.exports=eval("require")("koa2-cors")},764:module=>{module.exports=eval("require")("mysql2")},506:module=>{module.exports=eval("require")("node-bugjs")},464:module=>{module.exports=eval("require")("node-fetch")},927:module=>{module.exports=eval("require")("random-useragent")},261:module=>{module.exports=eval("require")("safe-buffer")},282:e=>{"use strict";e.exports=require("module")}};var __webpack_module_cache__={};function __nccwpck_require__(e){var t=__webpack_module_cache__[e];if(t!==undefined){return t.exports}var a=__webpack_module_cache__[e]={exports:{}};var r=true;try{__webpack_modules__[e](a,a.exports,__nccwpck_require__);r=false}finally{if(r)delete __webpack_module_cache__[e]}return a.exports}(()=>{__nccwpck_require__.n=e=>{var t=e&&e.__esModule?()=>e["default"]:()=>e;__nccwpck_require__.d(t,{a:t});return t}})();(()=>{__nccwpck_require__.d=(e,t)=>{for(var a in t){if(__nccwpck_require__.o(t,a)&&!__nccwpck_require__.o(e,a)){Object.defineProperty(e,a,{enumerable:true,get:t[a]})}}}})();(()=>{__nccwpck_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{__nccwpck_require__.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var __webpack_exports__={};(()=>{"use strict";__nccwpck_require__.r(__webpack_exports__);var e=__nccwpck_require__(975);var t=__nccwpck_require__.n(e);var a=__nccwpck_require__(62);var r=__nccwpck_require__.n(a);var s=__nccwpck_require__(180);var _=__nccwpck_require__.n(s);var i=__nccwpck_require__(243);var n=__nccwpck_require__.n(i);class Base{static filter_image_list(e,t){let a=[];let r=0;for(let s in e){r++;let _=e[s];a.push({sequence:r,page_id:t,src:_})}return a}}var l=__nccwpck_require__(80);const o={EVENT_SUBSCRIBE:"sub",EVENT_UNSUBSCRIBE:"unsub",TASK_SUCCESS:true,TASK_FAILED:false,SCENE_CHAPTER_LIST:"chapter_list",SCENE_IMAGE_LIST:"image_list",MQ_CONSUMER_BLOCK_SECOND:3};const c=o;const u={AMQP_EXCHANGE_TOPIC:"amq.topic",AMQP_ROUTING_KEY_COMIC_BASE:"spider.comic.base",AMQP_QUEUE_COMIC_BASE:"spider_comic_base",AMQP_ROUTING_KEY_SUPPLIER_BASE:"spider.supplier.base",AMQP_QUEUE_SUPPLIER_BASE:"spider_supplier_base",AMQP_QUEUE_SUPPLIER_CHAPTER:"spider_supplier_chapter",AMQP_ROUTING_KEY_SUPPLIER_CHAPTER:"spider.supplier.chapter",AMQP_QUEUE_SUPPLIER_CHAPTER_INFO:"spider_supplier_chapter_info"};const d=u;var p=__nccwpck_require__(427);var h=__nccwpck_require__.n(p);const f={host:"172.19.0.1",port:5672,user:"xxxx",password:"xxxxx",vhost:"/"};var g=__nccwpck_require__(261);var E=__nccwpck_require__.n(g);const m=E().Buffer;const w={durable:true,autoDelete:false};const b={noAck:false};const S=30;const y=180;const C=-1;const x=false;const T=true;const I=false;const k=true;const N=false;class RabbitMQ{set_exchange(e){this.exchange=e}set_routing_key(e){this.routing_key=e}set_queue(e){this.queue=e}set_block_second(e){this.block_second=e||S}set_pull_timeout(e,t){this.pull_timeout=e||C;this.auto_exit=t||I}get_conn(){const e=`amqp://${f.user}:${f.password}@${f.host}:${f.port}${f.vhost}`;return h().connect(e)}async prepare(){if(!this.conn){this.conn=await this.get_conn()}const e=await this.conn.createChannel();await e.assertQueue(this.queue,w);await e.bindQueue(this.queue,this.exchange,this.routing_key,null);return{conn:this.conn,channel:e}}async pull(e){const{conn:t,channel:a}=await this.prepare();for(;;){await new Promise((t=>{a.get(this.queue,b).then((r=>{let s=-1;if(this.pull_timeout>0){new Promise((e=>{s=setTimeout((()=>{if(this.auto_exit===T){console.log("Consumer Timeout. Progress is going to shutdown");process.exit()}}),this.pull_timeout*1e3)}))}if(x===r){setTimeout((()=>{t()}),this.block_second*1e3)}else{let _=r.content.toString();e(JSON.parse(_)).then((e=>{if(s>0){clearTimeout(s)}if(k===e||e===undefined){a.ack(r)}else{console.log("Failed payload ACK_NO "+_);a.reject(r)}t()})).catch((e=>{console.log("Failed payload Err "+_)}))}}))})).catch((e=>{a.close();t.close();console.error("Pull Err: ",e)}))}}async push(e){const{conn:t,channel:a}=await this.prepare();await a.publish(this.exchange,this.routing_key,m.from(JSON.stringify(e)));await a.close();await t.close()}async push_multi(e){const{conn:t,channel:a}=await this.prepare();for(let t in e){let r=e[t];await a.publish(this.exchange,this.routing_key,m.from(JSON.stringify(r)))}await a.close();await t.close()}}const L={read:[{host:"172.19.0.1",port:13306,user:"root",password:"s435d6f7g8ui",database:"curl_avatar",connection_limit:5}],write:[{host:"172.19.0.1",port:13306,user:"yth_blog",password:"s435d6f7g8ui",database:"curl_avatar",connection_limit:5}],show_sql:false};var U=__nccwpck_require__(764);var M=__nccwpck_require__.n(U);var A=__nccwpck_require__(4);const O=A.Z.format_time("Y-m-d h:i:s");const q="write";const R="read";class Handler{static execute(...e){const t=e[0];const a=e[1];const r=e[2];const s=e[3];s.getConnection(((e,_)=>{if(e){l.Z.error("SQL Exception: ",e.message);return}_.promise().execute(t,a).then((e=>{r(e)})).catch((e=>{const r=A.Z.uuid();l.Z.error(r,"SQL Exception: ",e);l.Z.warn(r,"SQL: ",t);let s="";if(a){s=JSON.stringify(a)}l.Z.warn(r,"SQL Values: ",s);_.close()})).finally((()=>{s.releaseConnection(_)}))}))}static do_insert(e,t,a){false===t instanceof Array?t=[t]:null;const r=t.length;if(0==r){throw new Error("插入数据不能为空")}let s=t[0];let _=[];let i=[];for(let e in s){_.push(e);i.push("`"+e+"`")}const n=_.length;let l=[];let o=`INSERT INTO \`${e}\` ( ${i.join(",")} )VALUES`;let c=[];for(let e=0;e<r;e++){let a=[];for(let r in _){a.push("?");l.push(t[e][_[r]])}let r="(";r+=a.join(",");r+=")";c.push(r)}o+=c.join(",");if(a!=""){o+=" "+a+" "}return{sql:o,datas:l}}static handle_where_in(e,t,a){let r=e.length;if(0===r){throw new Error("WHERE in 入参不能为空数组")}let s="";let _=[];for(let t in e){_.push("?");a.push(e[t])}if(undefined!==t){s+=" Not "}s+="In ("+_.join(",")+") ";return{sql_in:s,datas_new:a}}static handle_where(e,t){let a="";let r=[];t=undefined===t?[]:t;let s="";if(e.ORDER!==undefined){let t=[];let a=e.ORDER;delete e.ORDER;for(let e in a){let r=a[e];t.push(`\`${e}\` ${r}`)}s=` ORDER BY `+t.join(",")}let _="";if(e.LIMIT!==undefined){let t=e.LIMIT;delete e.LIMIT;if("object"==typeof t){_=` Limit ${t[0]},${t[1]}`}else{_=` Limit ${t}`}}for(let a in e){let s=e[a];let _=a.match(/(.*?)\[(.*?)\]/);if(null===_){if("object"==typeof s){let{sql_in:e,datas_new:_}=Handler.handle_where_in(s,undefined,t);if(null===e){continue}r.push(`\`${a}\` ${e}`);t=_}else{r.push(`\`${a}\` = ?`);t.push(s)}}else{a=_[1];let e=_[2];if("object"==typeof s){let{sql_in:e,datas_new:_}=Handler.handle_where_in(s,"not in",t);if(null===e){continue}r.push(`\`${a}\` ${e}`);t=_}else{r.push(`\`${a}\` ${e} ?`);t.push(s)}}}if(r.length>0){a+=` WHERE `+r.join(" AND ")}a+=s+_;return{sql_where:a,datas:t}}static do_select(e,t){let a=`SELECT * FROM \`${e}\` `;let{sql_where:r,datas:s}=this.handle_where(t);a+=r;return{sql:a,datas:s}}static do_update(e,t,a){let r=`UPDATE \`${e}\` SET `;let s=[];if(0==t.length){throw new Error("请输入更新条件")}let _=[];for(let e in t){let a=t[e];_.push(`\`${e}\` = ?`);s.push(a)}let{sql_where:i,datas:n}=this.handle_where(a,s);r+=_.join(",")+i;return{sql:r,datas:n}}static get_pool_by_action(e,t){if(!this.instance){this.instance={}}let a=e[t];let r=t+"_"+a[0].database;if(undefined===this.instance[r]){let e=this;let t=a.length;let s=A.Z.mt_rand(0,t-1);let _=a[s];const i=M().createPool({host:_.host,port:_.port,user:_.user,password:_.password,database:_.database,waitForConnections:true,connectionLimit:_.connection_limit,queueLimit:0});this.instance[r]=i}return this.instance[r]}}class BaseModel{static get_dsn(e){throw new Error("请实现该 Model 的 get_dsn 返回")}static get_table(){throw new Error("请重写 get_table 方法，返回 {数据表中名字}")}static get_dsn(){throw new Error("请在数据库模型基类重写 get_dsn 方法，返回数据库DSN配置")}static async insert(e,t=""){let a=this.get_table();let{sql:r,datas:s}=Handler.do_insert(a,e,t);const _=await new Promise((e=>{Handler.execute(r,s,(([t])=>{e(t)}),Handler.get_pool_by_action(this.get_dsn(),q))}));return{rows:_.affectedRows,first_insert_id:_.insertId}}static async select(e){let t=this.get_table();let{sql:a,datas:r}=Handler.do_select(t,e);let s=[];const _=await new Promise((e=>{Handler.execute(a,r,(([t])=>{e(t)}),Handler.get_pool_by_action(this.get_dsn(),R))}));return _}static async query(e,t){let a=[];await new Promise((r=>{Handler.execute(e,t,(e=>{a=e[0];r(true)}),Handler.get_pool_by_action(this.get_dsn(),R))}));return a}static async execute(e,t){await new Promise((a=>{Handler.execute(e,t,(e=>{a(true)}),Handler.get_pool_by_action(this.get_dsn(),q))}));return}static async update(e,t){let a=this.get_table();let{sql:r,datas:s}=Handler.do_update(a,e,t);let _=0;await new Promise((e=>{Handler.execute(r,s,(t=>{_=t.affectedRows;e(true)}),Handler.get_pool_by_action(this.get_dsn(),q))}));return _}}const P=BaseModel;class Base_Base extends P{static get_dsn(){return L}}const D=Base_Base;class Supplier extends D{static get_table(){return"supplier"}}const v=Supplier;var B=__nccwpck_require__(322);class SupplierData{static async offline_all_supplier_by_related_id(e){const t={related_id:e,status:B.SC.ONLINE};const a={status:B.SC.OFFLINE};return v.update(a,t)}static async get_list_by_related_id(e){const t={related_id:e,status:B.SC.ONLINE,ORDER:{id:"ASC"}};const a=await v.select(t);if(0===a.length){return[]}return a}static async get_not_deleted_list_by_related_id(e){const t={related_id:e,"status[!=]":B.SC.DELETED,ORDER:{id:"ASC"}};const a=await v.select(t);if(0===a.length){return[]}return a}static async get_one_by_id(e){const t={id:e,ORDER:{id:"ASC"},LIMIT:1};const a=await v.select(t);if(0===a.length){return null}return a[0]}static async get_by_id_list(e){const t={id:e,ORDER:{id:"ASC"}};const a=await v.select(t);if(0===a.length){return[]}return a}static update_supplier_by_id(e,t){const a={id:e};return v.update(t,a)}static get_channel_text(e){let t="";switch(parseInt(e)){case B.r8.GU_FENG:t="古风漫画";break;case B.r8.LIU_MAN_HUA:t="六漫画";break}return t}static get_source_href(e,t){let a="";switch(parseInt(e)){case B.r8.GU_FENG:a=`https://www.gufengmh8.com/manhua/${t}/`;break;case B.r8.LIU_MAN_HUA:a=`http://www.sixmh6.com/${t}/`;break}return a}}class Comic extends D{static get_table(){return"comic"}}const W=Comic;const Z={UNKNOWN:0,AUTO:1,AUTO_ONCE:2,MANUAL_TRIGGER:3};const K={DELETED:0,OFFLINE:100,ONLINE:200};class ComicData{static async get_comic_by_id(e){const t={id:e,ORDER:{id:"asc"},LIMIT:1};const a=await W.select(t);if(0===a.length){return null}return a[0]}static update_comic_by_id(e,t){const a={id:e};return W.update(t,a)}static async get_list_available(){const e={status:[K.OFFLINE,K.ONLINE],ORDER:{weight:"DESC"}};const t=await W.select(e);if(0===t.length){return[]}return t}}var $=__nccwpck_require__(971);class SupplierChapter extends D{static get_table(){return"supplier_chapter"}}const H=SupplierChapter;const Q={DELETED:0,WAIT:100,ONLINE:200};class SupplierChapterData{static async get_list_by_related_id(e){const t={related_id:e,status:Q.ONLINE,ORDER:{id:"ASC"}};const a=await H.select(t);if(0===a.length){return[]}return a}static async get_list_by_id_sequence_list(e,t){const a={related_id:e,status:[Q.WAIT,Q.ONLINE],sequence:t,ORDER:{id:"ASC"}};const r=await H.select(a);if(0===r.length){return[]}return r}static async get_chapter_by_id(e){const t={id:e,ORDER:{id:"asc"},LIMIT:1};const a=await H.select(t);if(0===a.length){return null}return a[0]}static async do_insert(e){let t="ON DUPLICATE KEY UPDATE status = VALUES( status )";return H.insert(e,t)}static set_status_ok_by_id(e){const t={id:e};const a={status:Q.ONLINE};return H.update(a,t)}}class ArrayTool{static column(e,t){let a=[];for(let r in e){a.push(e[r][t])}return a}static map_by_key(e,t){let a={};for(let r in e){let s=e[r][t];a[s]=e[r]}return a}}class SupplierImage extends D{static get_table(){return"supplier_image"}}const G=SupplierImage;const F={DELETED:0,ONLINE:200};class SupplierImageData{static async do_insert(e){let t="ON DUPLICATE KEY UPDATE status = VALUES( status )";return G.insert(e,t)}static delete_by_related_id(e){const t={related_id:e};const a={status:F.DELETED};return G.update(a,t)}}var j=__nccwpck_require__(420);var z=__nccwpck_require__(833);const Y=__nccwpck_require__(282);const V=__nccwpck_require__(464);const J=__nccwpck_require__(603);class LiuManHuaService extends j.Z{static async get_base_info(e,t){l.Z.ctxInfo(e,`开始拉取 source_id ${t} 基本信息`);let a=`http://www.sixmh6.com/${t}/`;let r={headers:{"User-Agent":z.Z.fake_one()},timeout:3e3};return V(a,r).then((e=>e.text())).then((a=>{const r=J.load(a);let s=r(".cy_title").find("h1").text();let _=r(".cy_info_cover img").eq(0).attr("src");let i=r(".cy_desc p").eq(0).text().trim("");l.Z.ctxInfo(e,"数据如下",{name:s,pic:_,intro:i});l.Z.ctxInfo(e,`拉取结束 source_id ${t} 基本信息`);return{name:s,pic:_,intro:i}}))}static async get_chapter_list(e,t){let a=this;l.Z.ctxInfo(e,`开始拉取 source_id ${t} 列表信息-头部`);let r=`http://www.sixmh6.com/${t}/`;let s=0;let _=[];let i={headers:{"User-Agent":z.Z.fake_one()},timeout:3e3};await V(r,i).then((e=>e.text())).then((e=>{const t=J.load(e);let r=t(".cy_plist li");let s=r.length;if(s>0){for(let e=0;e<s;e++){let t=r.eq(e);let s=t.find("a").attr("href");s=a.getLink(s);let i=t.find("p").text();let n={link:s,name:i};_.push(n)}}}));l.Z.ctxInfo(e,`开始拉取 source_id ${t} 列表信息-剩余部分`);let n=`http://www.sixmh6.com/bookchapter/`;let o={method:"POST",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`id=${t}&id2=1`};let c=0;await V(n,o).then((e=>e.text())).then((r=>{let i=JSON.parse(r);let n=i.length;for(let e=0;e<n;e++){let r=i[e];let n=a.getLink(`/${t}/${r.chapterid}.html`);let l=r.chaptername;s++;let o={link:n,name:l};_.push(o)}c=_.length;l.Z.ctxInfo(e,`拉取结束 source_id ${t} 总计章节数 ${c}`)}));let u=[];for(let e=0;e<c;e++){let t=c-1-e;let a=e+1;_[t]["sequence"]=a;u.push(_[t])}return u}static getLink(e){return`http://www.sixmh6.com/${e}`}static async get_image_list(e,t){let a=[];l.Z.ctxInfo(e,`开始拉取 ${t} 图片列表`);let r={headers:{"User-Agent":z.Z.fake_one()},timeout:3e3};return V(t,r).then((e=>e.text())).then((a=>{let r=a.match(/eval\((.*)\)/);let s=r[0];let _=`\n                    ${s} \n                    ;module.exports = newImgs\n                `;let i="tmp-runtime-module";const n=new Y(i);n._compile(_,i);let o=n.exports;l.Z.ctxInfo(e,`拉取结束 target_url ${t} 总计图片数 ${o.length}`);return o}))}}class TaskLogic extends Base{static async comic_base(e,t){let a=t.id;let r=t.event;const s=await ComicData.get_comic_by_id(a);if(!s){l.Z.ctxWarn(e,"ID不存在");return c.TASK_SUCCESS}switch(r){case c.EVENT_SUBSCRIBE:const t=await SupplierData.get_list_by_related_id(a);let r=t.length;if(r===0){l.Z.ctxInfo(e,"暂无渠道");break}const s=new RabbitMQ;s.set_exchange(d.AMQP_EXCHANGE_TOPIC);s.set_routing_key(d.AMQP_ROUTING_KEY_SUPPLIER_BASE);s.set_queue(d.AMQP_QUEUE_SUPPLIER_BASE);let _=[];for(let e=0;e<r;e++){let a=t[e];_.push({id:parseInt(a.id)})}await s.push_multi(_);l.Z.ctxInfo(e,`notify ${r} supplier success`);break;case c.EVENT_UNSUBSCRIBE:await SupplierData.offline_all_supplier_by_related_id(a);break;default:l.Z.ctxWarn(e,"event 异常")}return c.TASK_SUCCESS}static async supplier_base(e,t){let a=t.id;const r=await SupplierData.get_one_by_id(a);if(!r){l.Z.ctxWarn(e,"supplier_id 不存在");return}let s={};let _={name:"",pic:"",intro:""};let i,n,o="";switch(r.channel){case B.r8.GU_FENG:_=await $.Z.get_base_info(e,r.source_id);break;case B.r8.QI_MAN_WU:break;case B.r8.LIU_MAN_HUA:_=await LiuManHuaService.get_base_info(e,r.source_id);break;default:l.Z.ctxWarn(e,"channel 异常");return c.TASK_SUCCESS}i=A.Z.get_data_with_default(_.name,"");n=A.Z.get_data_with_default(_.pic,"");o=A.Z.get_data_with_default(_.intro,"");if(i==""&&n==""&&o==""){l.Z.ctxWarn(e,"本次未更新，因为渠道基本信息都是空的");l.Z.ctxWarn(e,_);return c.TASK_SUCCESS}if(i!=r.name||n!=r.pic||o!=r.intro){s.name=i;s.intro=o;s.pic=n;await SupplierData.update_supplier_by_id(a,s)}if(r.related_id>0){let t=r.related_id;const a=await ComicData.get_comic_by_id(t);if(!a){l.Z.ctxWarn(e,"comic_id 不存在");return c.TASK_SUCCESS}if(a.related_id==r.id&&(a.method==Z.AUTO||a.method==Z.AUTO_ONCE&&a.name=="")){let e={name:i,pic:n,intro:o};await ComicData.update_comic_by_id(t,e)}}return c.TASK_SUCCESS}static async supplier_chapter(e,t){let a=t.id;const r=await SupplierData.get_one_by_id(a);if(!r){l.Z.ctxWarn(e,"supplier_id 不存在");return}let s=[];switch(r.channel){case B.r8.GU_FENG:let t=r.ext_1;s=await $.Z.get_chapter_list(e,r.source_id,t);break;case B.r8.QI_MAN_WU:break;case B.r8.LIU_MAN_HUA:s=await LiuManHuaService.get_chapter_list(e,r.source_id);break;default:l.Z.ctxWarn(e,"channel 异常");return c.TASK_SUCCESS}let _=s.length;let i=_-1;let n=s[i]["sequence"];const o=await SupplierChapterData.get_list_by_related_id(a);let u=this.supplier_chapter_diff(e,o,s);let p=u.length;if(p===0){l.Z.ctxInfo(e,"暂无需要爬取的章节列表信息");return c.TASK_SUCCESS}let h=[];for(let e=0;e<p;e++){let t={related_id:a,sequence:u[e].sequence,name:u[e].name,status:Q.WAIT};h.push(t)}await SupplierChapterData.do_insert(h);let f=ArrayTool.column(h,"sequence");let g=await SupplierChapterData.get_list_by_id_sequence_list(a,f);let E=ArrayTool.map_by_key(g,"sequence");const m=new RabbitMQ;m.set_exchange(d.AMQP_EXCHANGE_TOPIC);m.set_routing_key(d.AMQP_ROUTING_KEY_SUPPLIER_CHAPTER);m.set_queue(d.AMQP_QUEUE_SUPPLIER_CHAPTER_INFO);let w=[];for(let e=0;e<p;e++){let t=u[e];let a=E[t.sequence].id;w.push({id:a,link:t.link})}await m.push_multi(w);let b={max_sequence:n};await SupplierData.update_supplier_by_id(a,b);return c.TASK_SUCCESS}static supplier_chapter_diff(e,t,a){let r=[];let s={};let _=t.length;for(let e=0;e<_;e++){let a=t[e].sequence;s[a]=1}let i=a.length;if(i===0){return r}for(let e=0;e<i;e++){let t=a[e];let _=t.sequence;if(s[_]){continue}let i=JSON.parse(JSON.stringify(t));r.push(i)}return r}static async supplier_image(e,t){let a=t.id;let r=t.link;const s=await SupplierChapterData.get_chapter_by_id(a);if(!s){l.Z.ctxWarn(e,"chapter_id 不存在");return c.TASK_SUCCESS}const _=await SupplierData.get_one_by_id(s.related_id);if(!_){l.Z.ctxWarn(e,"supplier_id 不存在");return}await SupplierImageData.delete_by_related_id(a);let i=[];switch(_.channel){case B.r8.GU_FENG:i=await $.Z.get_image_list(e,r);break;case B.r8.QI_MAN_WU:break;case B.r8.LIU_MAN_HUA:i=await LiuManHuaService.get_image_list(e,r);break;default:l.Z.ctxWarn(e,"channel 异常");return c.TASK_SUCCESS}let n=i.length;if(!n||n===0){return c.TASK_SUCCESS}let o=[];for(let e=0;e<n;e++){o.push({src_origin:i[e],related_id:a,sequence:e+1,status:F.ONLINE})}await SupplierImageData.do_insert(o);l.Z.ctxInfo(e,`one_chapter.id ${s.id}`);await SupplierChapterData.set_status_ok_by_id(s.id);return c.TASK_SUCCESS}static async notify_sub(e,t){let a=[];if(t===undefined){let e=await ComicData.get_list_available();let t=e.length;for(let r=0;r<t;r++){let t={id:parseInt(e[r].id),event:c.EVENT_SUBSCRIBE};a.push(t)}}else{let e={id:parseInt(t),event:c.EVENT_SUBSCRIBE};a.push(e)}let r=a.length;if(r===0){l.Z.ctxWarn(e,"暂无需要通知订阅的漫画");return}const s=new RabbitMQ;s.set_exchange(d.AMQP_EXCHANGE_TOPIC);s.set_routing_key(d.AMQP_ROUTING_KEY_COMIC_BASE);s.set_queue(d.AMQP_QUEUE_COMIC_BASE);await s.push_multi(a);l.Z.ctxInfo(e,`通知订阅成功,总计 ${r} 个`)}}const X={SUCCESS:0,FORBIDDEN:403,NOT_FOUND:404,BUSINESS_ERROR:500,INNER_ERROR:502};const ee=X;const te="trace_id";class ContextTool{constructor(){this.data_bucket=new Object;this.time_bucket=new Object;this.is_cancel=false}static initial(){let e=new this;e=ContextTool.with_value(e,te,A.Z.uuid());return e}static with_value(e,t,a){let r=new this;let s=JSON.stringify(e.data_bucket);let _=JSON.parse(s);let i=JSON.stringify(e.time_bucket);let n=JSON.parse(i);_[t]=a;n[t]=parseInt((new Date).getTime()/1e3);r.data_bucket=_;r.time_bucket=n;return r}get_value(e){let t=this;let a=t.data_bucket[e];if(undefined==a){return""}return a}get_value_time(e){let t=this;let a=t.time_bucket[e];if(undefined==a){return""}return a}get_trace_id(){let e=this;return e.get_value(te)}}class base_Base{static response_default(){let e={code:ee.SUCCESS,msg:"success",data:null};return e}static response_default_with_ctx(){let e=base_Base.response_default();let t=ContextTool.initial();return{response:e,ctx:t}}static require_client_name(e){let t=e.request.query.client_name;if(!t){throw new Error("请传入 client_name")}}}var ae=__nccwpck_require__(403);var re=__nccwpck_require__(889);var se=__nccwpck_require__(457);class SentryTool{static captureException(e){if(se.oj===""){return}if(!this.sentry){ae.init({dsn:se.oj,tracesSampleRate:1});this.sentry=true}ae.captureException(e)}}class Notify extends base_Base{static async sub(e){let{response:t,ctx:a}=base_Base.response_default_with_ctx();try{base_Base.require_client_name(e);let t=A.Z.get_data_with_default(e.request.query.comic_id,0);if(!t){t=undefined}await TaskLogic.notify_sub(a,t)}catch(e){console.log(e);SentryTool.captureException(e);t.code=ee.BUSINESS_ERROR;t.msg="failed!"}e.body=t}}class Open_Base_Base{static handle_datetime(e,t){let a=e.length;if(a>0){let r=t.split(",");for(let t=0;t<a;t++){for(let a in r){let s=r[a];let _=e[t][s];let i=new Date(_).getTime()/1e3;e[t][s]=A.Z.format_time("Y-m-d h:i:s",i)}}}return e}}class SupplierLogic extends Open_Base_Base{static async list_by_ids(e,t){let a=await SupplierData.get_by_id_list(t);a=Open_Base_Base.handle_datetime(a,"created_at,updated_at");a=SupplierLogic.list_add_parse_fields(a);return a}static async list_by_comic_id(e,t){let a=await SupplierData.get_not_deleted_list_by_related_id(t);a=Open_Base_Base.handle_datetime(a,"created_at,updated_at");a=SupplierLogic.list_add_parse_fields(a);return a}static async list_add_parse_fields(e){let t=e.length;if(t>0){for(let a=0;a<t;a++){let t=e[a]["channel"];let r=e[a]["source_id"];e[a]["text_channel"]=SupplierData.get_channel_text(t);e[a]["text_href"]=SupplierData.get_source_href(t,r)}}return e}}class supplier_Supplier extends base_Base{static async list_by_ids(e){let{response:t,ctx:a}=base_Base.response_default_with_ctx();try{base_Base.require_client_name(e);let r=A.Z.get_data_with_default(e.request.query.ids,"");if(!r){throw new Error("请传入 ids")}let s=r.split(",");let _=await SupplierLogic.list_by_ids(a,s);t.data={list:_}}catch(e){console.log(e);SentryTool.captureException(e);t.code=ee.BUSINESS_ERROR;t.msg="failed!"}e.body=t}static async list_by_comic_id(e){let{response:t,ctx:a}=base_Base.response_default_with_ctx();try{base_Base.require_client_name(e);let r=A.Z.get_data_with_default(e.request.query.comic_id,0);if(!r){throw new Error("请传入 comic_id")}let s=await SupplierLogic.list_by_comic_id(a,r);t.data={list:s}}catch(e){console.log(e);SentryTool.captureException(e);t.code=ee.BUSINESS_ERROR;t.msg="failed!"}e.body=t}}const _e=n()();const ie=r()();const ne=_()();const le=new(t());_e.get("/notify/sub",Notify.sub);_e.get("/supplier/list_by_ids",supplier_Supplier.list_by_ids);_e.get("/supplier/list_by_comic_id",supplier_Supplier.list_by_comic_id);le.use(ie);le.use(ne);le.use(_e.routes()).use(_e.allowedMethods());console.log("Listening node HTTP server Port on ",se.D8);le.listen(se.D8)})();module.exports=__webpack_exports__})();