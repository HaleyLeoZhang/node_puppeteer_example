(()=>{var __webpack_modules__={322:(e,t,a)=>{"use strict";a.d(t,{r8:()=>r,SC:()=>s});const r={UNKNOWN:0,GU_FENG:1,QI_MAN_WU:2,LIU_MAN_HUA:3};const s={DELETED:0,INVALID:50,OFFLINE:100,ONLINE:200};const _={}},420:(e,t,a)=>{"use strict";a.d(t,{Z:()=>s});var r=a(927);class BaseService{static get_fake_ua(){return r.getRandom()}static delay_ms(e){return new Promise((t=>setTimeout((()=>t()),e)))}}class Base extends BaseService{}const s=Base},971:(__unused_webpack_module,__webpack_exports__,__nccwpck_require__)=>{"use strict";__nccwpck_require__.d(__webpack_exports__,{Z:()=>GuFengService});var _Base__WEBPACK_IMPORTED_MODULE_0__=__nccwpck_require__(420);var _tools_Log__WEBPACK_IMPORTED_MODULE_1__=__nccwpck_require__(813);var _models_CurlAvatar_Supplier_Enum__WEBPACK_IMPORTED_MODULE_2__=__nccwpck_require__(322);var _tools_UserAgentTool__WEBPACK_IMPORTED_MODULE_3__=__nccwpck_require__(833);const fetch=__nccwpck_require__(464);const cheerio=__nccwpck_require__(603);class GuFengService extends _Base__WEBPACK_IMPORTED_MODULE_0__.Z{static async get_base_info(e,t){_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,`开始拉取 source_id ${t} 基本信息`);let a=`https://www.gufengmh8.com/manhua/${t}/`;let r={headers:{"User-Agent":_tools_UserAgentTool__WEBPACK_IMPORTED_MODULE_3__.Z.fake_one()},timeout:3e3};return fetch(a,r).then((e=>e.text())).then((a=>{const r=cheerio.load(a);let s=r(".book-title").find("span").text();let _=r(".book-cover").find("img").attr("src");let i=r("#intro-all").text().trim("");_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,"数据如下",{name:s,pic:_,intro:i});_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,`拉取结束 source_id ${t} 基本信息`);return{name:s,pic:_,intro:i}}))}static async get_chapter_list(e,t,a){_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,`开始拉取 source_id ${t} 基本信息`);let r=`https://www.gufengmh8.com/manhua/${t}/`;let s={headers:{"User-Agent":_tools_UserAgentTool__WEBPACK_IMPORTED_MODULE_3__.Z.fake_one()},timeout:3e3};return fetch(r,s).then((e=>e.text())).then((r=>{let s=[];const _=cheerio.load(r);let i=_(".comic-chapters");let n=i.length;if(i===undefined||n===0){_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxError(e,"爬取章节TAB失败");return s}for(let t=0;t<n;t++){let r=i.eq(t);let _=r.find(".caption span").text().trim();if(a==_){let t=r.find("li");let a=t.length;if(t===undefined||a===0){_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxError(e,"爬取章节列表失败");return s}for(let e=0;e<a;e++){let a=t.eq(e);let r=a.find("a").attr("href");r=`https://www.gufengmh8.com${r}`;let _=a.find("span").text();let i=e+1;let n={link:r,name:_,sequence:i};s.push(n)}}}_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(e,`拉取结束 source_id ${t} 总计章节数 ${s.length}`);return s}))}static async get_image_list(ctx,target_url){let image_list=[];_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(ctx,`开始拉取 ${target_url} 图片列表`);let options={headers:{"User-Agent":_tools_UserAgentTool__WEBPACK_IMPORTED_MODULE_3__.Z.fake_one()},timeout:3e3};return fetch(target_url,options).then((e=>e.text())).then((html=>{let srcpt_tpls=html.match(/var siteName = "";(.*?)var prevChapterData/);let tpl=srcpt_tpls[1];let func_string=`(function tmp_func(data){\n                  let output = {}; ${tpl}\n                  output = {chapterImages,chapterPath,pageImage,}\n                  return output;\n                })`;let func=eval(func_string);let{chapterImages:chapterImages,chapterPath:chapterPath,pageImage:pageImage}=func();let matches=pageImage.match(/^.*?\/\/(.*?)\//);let img_host=matches[0];let img_path=chapterPath;let lenImg=chapterImages.length;for(let e=0;e<lenImg;e++){let t=img_host+img_path+chapterImages[e];image_list.push(t)}_tools_Log__WEBPACK_IMPORTED_MODULE_1__.Z.ctxInfo(ctx,`拉取结束 target_url ${target_url} 总计图片数 ${image_list.length}`);return image_list}))}}},4:(e,t,a)=>{"use strict";a.d(t,{Z:()=>General});class General{static uuid(){let e=[];let t="0123456789abcdef";for(let a=0;a<36;a++){e[a]=t.substr(Math.floor(Math.random()*16),1)}e[14]="4";e[19]=t.substr(e[19]&3|8,1);e[8]=e[13]=e[18]=e[23]="-";let a=e.join("");return a}static format_time(e,t){t=t===undefined?0:t;t=parseInt(t)*1e3;let a=t===0?new Date:new Date(t);const add_zero=e=>{if(e<=9){return"0"+e}else{return""+e+""}};let r,s,_,i,n,l;r=a.getFullYear();s=add_zero(a.getMonth()+1);_=add_zero(a.getDate());i=add_zero(a.getHours());n=add_zero(a.getMinutes());l=add_zero(a.getSeconds());e=e.replace("Y",r);e=e.replace("m",s);e=e.replace("d",_);e=e.replace("h",i);e=e.replace("i",n);e=e.replace("s",l);return e}static mt_rand(e,t){return parseInt(Math.random()*(t-e+1)+e,10)}static is_json(e){if(typeof e=="string"){try{JSON.parse(e);return true}catch(e){return false}}return false}static get_data_with_default(e,t){if(typeof e==="undefined"||e==null){return t}return e}}},813:(e,t,a)=>{"use strict";a.d(t,{Z:()=>f});const r=require("fs");var s=a.n(r);var _=a(4);const i=__dirname+"/../../";const n={executablePath:"C:/Program Files (x86)/Google/Chrome/Application/chrome.exe",timeout:15e3,ignoreHTTPSErrors:true,devtools:false,headless:true};let l={path:i+"storage/imgs/"+_.Z.uuid()+".png",type:"png",quality:100,fullPage:true,args:["–-disable-gpu","–-disable-dev-shm-usage","–-disable-setuid-sandbox","–-no-first-run","–-no-sandbox","–-no-zygote","–-single-process"]};const o={bright:true,absolute:false,date:false,console:true,debug:true,store:true,log_path:"/tmp/comic"};const c="https://dfe6457f6176454d8c27edc2f8752741@o481346.ingest.sentry.io/5584132";const u={access_key:"asdasdad",secret_key:"",bucket_name:"",cdn_host:""};const p=7070;var d=a(506);var h=a.n(d);const E=new(h())(o);E.storeHandler=e=>{let t=[];for(let a in e){switch(a){case"date":let r=_.Z.format_time("Y-m-d h:i:s");e[a]=`[${r}]`;t.push(e[a]);break;default:break}}t.push(" ");const a=_.Z.format_time("Y-m-d")+".log";const r=o.log_path+"/"+a;s().appendFileSync(r,t.concat(e.logs).join("")+"\n")};E.ctxInfo=(e,t)=>{E.info(e.get_trace_id()+"  "+t)};E.ctxError=(e,t)=>{E.error(e.get_trace_id()+"  "+t)};E.ctxWarn=(e,t)=>{E.warn(e.get_trace_id()+"  "+t)};const f=E},833:(e,t,a)=>{"use strict";a.d(t,{Z:()=>UserAgentTool});var r=a(4);const s=["Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.12) Gecko/20070731 Ubuntu/dapper-security Firefox/1.5.0.12","Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; Acoo Browser; SLCC1; .NET CLR 2.0.50727; Media Center PC 5.0; .NET CLR 3.0.04506)","Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.56 Safari/535.11","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_3) AppleWebKit/535.20 (KHTML, like Gecko) Chrome/19.0.1036.7 Safari/535.20","Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6","Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.71 Safari/537.1 LBBROWSER","Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 2.0.50727; Media Center PC 6.0) ,Lynx/2.8.5rel.1 libwww-FM/2.14 SSL-MM/1.4.1 GNUTLS/1.2.9","Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)","Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; QQBrowser/7.0.3698.400)","Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E)","Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:2.0b13pre) Gecko/20110307 Firefox/4.0b13pre","Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; fr) Presto/2.9.168 Version/11.52","Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.0.12) Gecko/20070731 Ubuntu/dapper-security Firefox/1.5.0.12","Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; LBBROWSER)","Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6","Mozilla/5.0 (X11; U; Linux; en-US) AppleWebKit/527+ (KHTML, like Gecko, Safari/419.3) Arora/0.6","Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; QQBrowser/7.0.3698.400)","Opera/9.25 (Windows NT 5.1; U; en), Lynx/2.8.5rel.1 libwww-FM/2.14 SSL-MM/1.4.1 GNUTLS/1.2.9","Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"];class UserAgentTool{static fake_one(){let e=0;let t=s.length-1;let a=r.Z.mt_rand(e,t);return s[a]}}},427:module=>{module.exports=eval("require")("amqplib")},603:module=>{module.exports=eval("require")("cheerio")},764:module=>{module.exports=eval("require")("mysql2")},506:module=>{module.exports=eval("require")("node-bugjs")},464:module=>{module.exports=eval("require")("node-fetch")},927:module=>{module.exports=eval("require")("random-useragent")},261:module=>{module.exports=eval("require")("safe-buffer")},282:e=>{"use strict";e.exports=require("module")}};var __webpack_module_cache__={};function __nccwpck_require__(e){var t=__webpack_module_cache__[e];if(t!==undefined){return t.exports}var a=__webpack_module_cache__[e]={exports:{}};var r=true;try{__webpack_modules__[e](a,a.exports,__nccwpck_require__);r=false}finally{if(r)delete __webpack_module_cache__[e]}return a.exports}(()=>{__nccwpck_require__.n=e=>{var t=e&&e.__esModule?()=>e["default"]:()=>e;__nccwpck_require__.d(t,{a:t});return t}})();(()=>{__nccwpck_require__.d=(e,t)=>{for(var a in t){if(__nccwpck_require__.o(t,a)&&!__nccwpck_require__.o(e,a)){Object.defineProperty(e,a,{enumerable:true,get:t[a]})}}}})();(()=>{__nccwpck_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{__nccwpck_require__.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var __webpack_exports__={};(()=>{"use strict";__nccwpck_require__.r(__webpack_exports__);var e=__nccwpck_require__(813);class Register{bootstrap(){const e=process.argv;this.load_module=undefined===e[2]?undefined:e[2];this.load_action=undefined===e[3]?undefined:e[3];this.resgist_list={};return this}use(e,t){this.resgist_list[e]=t;return this}get_action(){const t=this.resgist_list[this.load_module];if(undefined===t){e.Z.log(this.load_module+" 模块---不存在")}const a=t[this.load_action];if(undefined===a){e.Z.log(this.load_action+" 方法---不存在")}return a}run(){const t=this.get_action();e.Z.log("--------START--------");e.Z.log("正在调用---模块 "+this.load_module+"---方法---"+this.load_action);t().then((()=>{e.Z.log("---------END---------");process.exit()})).catch((t=>{e.Z.error("Exception: ",t.stack);process.exit()}))}}class BaseTask{}var t=__nccwpck_require__(427);var a=__nccwpck_require__.n(t);const r={host:"172.19.0.1",port:5672,user:"xxxx",password:"xxxxx",vhost:"/"};var s=__nccwpck_require__(261);var _=__nccwpck_require__.n(s);const i=_().Buffer;const n={durable:true,autoDelete:false};const l={noAck:false};const o=30;const c=180;const u=-1;const p=false;const d=true;const h=false;const E=true;const f=false;class RabbitMQ{set_exchange(e){this.exchange=e}set_routing_key(e){this.routing_key=e}set_queue(e){this.queue=e}set_block_second(e){this.block_second=e||o}set_pull_timeout(e,t){this.pull_timeout=e||u;this.auto_exit=t||h}get_conn(){const e=`amqp://${r.user}:${r.password}@${r.host}:${r.port}${r.vhost}`;return a().connect(e)}async prepare(){if(!this.conn){this.conn=await this.get_conn()}const e=await this.conn.createChannel();await e.assertQueue(this.queue,n);await e.bindQueue(this.queue,this.exchange,this.routing_key,null);return{conn:this.conn,channel:e}}async pull(e){const{conn:t,channel:a}=await this.prepare();for(;;){await new Promise((t=>{a.get(this.queue,l).then((r=>{let s=-1;if(this.pull_timeout>0){new Promise((e=>{s=setTimeout((()=>{if(this.auto_exit===d){console.log("Consumer Timeout. Progress is going to shutdown");process.exit()}}),this.pull_timeout*1e3)}))}if(p===r){setTimeout((()=>{t()}),this.block_second*1e3)}else{let _=r.content.toString();e(JSON.parse(_)).then((e=>{if(s>0){clearTimeout(s)}if(E===e||e===undefined){a.ack(r)}else{console.log("Failed payload ACK_NO "+_);a.reject(r)}t()})).catch((e=>{console.log("Failed payload Err "+_)}))}}))})).catch((e=>{a.close();t.close();console.error("Pull Err: ",e)}))}}async push(e){const{conn:t,channel:a}=await this.prepare();await a.publish(this.exchange,this.routing_key,i.from(JSON.stringify(e)));await a.close();await t.close()}async push_multi(e){const{conn:t,channel:a}=await this.prepare();for(let t in e){let r=e[t];await a.publish(this.exchange,this.routing_key,i.from(JSON.stringify(r)))}await a.close();await t.close()}}const g={EVENT_SUBSCRIBE:"sub",EVENT_UNSUBSCRIBE:"unsub",TASK_SUCCESS:true,TASK_FAILED:false,SCENE_CHAPTER_LIST:"chapter_list",SCENE_IMAGE_LIST:"image_list",MQ_CONSUMER_BLOCK_SECOND:3};const m=g;const w={AMQP_EXCHANGE_TOPIC:"amq.topic",AMQP_ROUTING_KEY_COMIC_BASE:"spider.comic.base",AMQP_QUEUE_COMIC_BASE:"spider_comic_base",AMQP_ROUTING_KEY_SUPPLIER_BASE:"spider.supplier.base",AMQP_QUEUE_SUPPLIER_BASE:"spider_supplier_base",AMQP_QUEUE_SUPPLIER_CHAPTER:"spider_supplier_chapter",AMQP_ROUTING_KEY_SUPPLIER_CHAPTER:"spider.supplier.chapter",AMQP_QUEUE_SUPPLIER_CHAPTER_INFO:"spider_supplier_chapter_info"};const S=w;var b=__nccwpck_require__(4);const C="trace_id";class ContextTool{constructor(){this.data_bucket=new Object;this.time_bucket=new Object;this.is_cancel=false}static initial(){let e=new this;e=ContextTool.with_value(e,C,b.Z.uuid());return e}static with_value(e,t,a){let r=new this;let s=JSON.stringify(e.data_bucket);let _=JSON.parse(s);let i=JSON.stringify(e.time_bucket);let n=JSON.parse(i);_[t]=a;n[t]=parseInt((new Date).getTime()/1e3);r.data_bucket=_;r.time_bucket=n;return r}get_value(e){let t=this;let a=t.data_bucket[e];if(undefined==a){return""}return a}get_value_time(e){let t=this;let a=t.time_bucket[e];if(undefined==a){return""}return a}get_trace_id(){let e=this;return e.get_value(C)}}class Base{static filter_image_list(e,t){let a=[];let r=0;for(let s in e){r++;let _=e[s];a.push({sequence:r,page_id:t,src:_})}return a}}const I={read:[{host:"172.19.0.1",port:13306,user:"root",password:"s435d6f7g8ui",database:"curl_avatar",connection_limit:5}],write:[{host:"172.19.0.1",port:13306,user:"yth_blog",password:"s435d6f7g8ui",database:"curl_avatar",connection_limit:5}],show_sql:false};var T=__nccwpck_require__(764);var A=__nccwpck_require__.n(T);const x=b.Z.format_time("Y-m-d h:i:s");const M="write";const y="read";class Handler{static execute(...t){const a=t[0];const r=t[1];const s=t[2];const _=t[3];_.getConnection(((t,i)=>{if(t){e.Z.error("SQL Exception: ",t.message);return}i.promise().execute(a,r).then((e=>{s(e)})).catch((t=>{const s=b.Z.uuid();e.Z.error(s,"SQL Exception: ",t);e.Z.warn(s,"SQL: ",a);let _="";if(r){_=JSON.stringify(r)}e.Z.warn(s,"SQL Values: ",_);i.close()})).finally((()=>{_.releaseConnection(i)}))}))}static do_insert(e,t,a){false===t instanceof Array?t=[t]:null;const r=t.length;if(0==r){throw new Error("插入数据不能为空")}let s=t[0];let _=[];let i=[];for(let e in s){_.push(e);i.push("`"+e+"`")}const n=_.length;let l=[];let o=`INSERT INTO \`${e}\` ( ${i.join(",")} )VALUES`;let c=[];for(let e=0;e<r;e++){let a=[];for(let r in _){a.push("?");l.push(t[e][_[r]])}let r="(";r+=a.join(",");r+=")";c.push(r)}o+=c.join(",");if(a!=""){o+=" "+a+" "}return{sql:o,datas:l}}static handle_where_in(e,t,a){let r=e.length;if(0===r){throw new Error("WHERE in 入参不能为空数组")}let s="";let _=[];for(let t in e){_.push("?");a.push(e[t])}if(undefined!==t){s+=" Not "}s+="In ("+_.join(",")+") ";return{sql_in:s,datas_new:a}}static handle_where(e,t){let a="";let r=[];t=undefined===t?[]:t;let s="";if(e.ORDER!==undefined){let t=[];let a=e.ORDER;delete e.ORDER;for(let e in a){let r=a[e];t.push(`\`${e}\` ${r}`)}s=` ORDER BY `+t.join(",")}let _="";if(e.LIMIT!==undefined){let t=e.LIMIT;delete e.LIMIT;if("object"==typeof t){_=` Limit ${t[0]},${t[1]}`}else{_=` Limit ${t}`}}for(let a in e){let s=e[a];let _=a.match(/(.*?)\[(.*?)\]/);if(null===_){if("object"==typeof s){let{sql_in:e,datas_new:_}=Handler.handle_where_in(s,undefined,t);if(null===e){continue}r.push(`\`${a}\` ${e}`);t=_}else{r.push(`\`${a}\` = ?`);t.push(s)}}else{a=_[1];let e=_[2];if("object"==typeof s){let{sql_in:e,datas_new:_}=Handler.handle_where_in(s,"not in",t);if(null===e){continue}r.push(`\`${a}\` ${e}`);t=_}else{r.push(`\`${a}\` ${e} ?`);t.push(s)}}}if(r.length>0){a+=` WHERE `+r.join(" AND ")}a+=s+_;return{sql_where:a,datas:t}}static do_select(e,t){let a=`SELECT * FROM \`${e}\` `;let{sql_where:r,datas:s}=this.handle_where(t);a+=r;return{sql:a,datas:s}}static do_update(e,t,a){let r=`UPDATE \`${e}\` SET `;let s=[];if(0==t.length){throw new Error("请输入更新条件")}let _=[];for(let e in t){let a=t[e];_.push(`\`${e}\` = ?`);s.push(a)}let{sql_where:i,datas:n}=this.handle_where(a,s);r+=_.join(",")+i;return{sql:r,datas:n}}static get_pool_by_action(e,t){if(!this.instance){this.instance={}}let a=e[t];let r=t+"_"+a[0].database;if(undefined===this.instance[r]){let e=this;let t=a.length;let s=b.Z.mt_rand(0,t-1);let _=a[s];const i=A().createPool({host:_.host,port:_.port,user:_.user,password:_.password,database:_.database,waitForConnections:true,connectionLimit:_.connection_limit,queueLimit:0});this.instance[r]=i}return this.instance[r]}}class BaseModel{static get_dsn(e){throw new Error("请实现该 Model 的 get_dsn 返回")}static get_table(){throw new Error("请重写 get_table 方法，返回 {数据表中名字}")}static get_dsn(){throw new Error("请在数据库模型基类重写 get_dsn 方法，返回数据库DSN配置")}static async insert(e,t=""){let a=this.get_table();let{sql:r,datas:s}=Handler.do_insert(a,e,t);const _=await new Promise((e=>{Handler.execute(r,s,(([t])=>{e(t)}),Handler.get_pool_by_action(this.get_dsn(),M))}));return{rows:_.affectedRows,first_insert_id:_.insertId}}static async select(e){let t=this.get_table();let{sql:a,datas:r}=Handler.do_select(t,e);let s=[];const _=await new Promise((e=>{Handler.execute(a,r,(([t])=>{e(t)}),Handler.get_pool_by_action(this.get_dsn(),y))}));return _}static async query(e,t){let a=[];await new Promise((r=>{Handler.execute(e,t,(e=>{a=e[0];r(true)}),Handler.get_pool_by_action(this.get_dsn(),y))}));return a}static async execute(e,t){await new Promise((a=>{Handler.execute(e,t,(e=>{a(true)}),Handler.get_pool_by_action(this.get_dsn(),M))}));return}static async update(e,t){let a=this.get_table();let{sql:r,datas:s}=Handler.do_update(a,e,t);let _=0;await new Promise((e=>{Handler.execute(r,s,(t=>{_=t.affectedRows;e(true)}),Handler.get_pool_by_action(this.get_dsn(),M))}));return _}}const O=BaseModel;class Base_Base extends O{static get_dsn(){return I}}const N=Base_Base;class Supplier extends N{static get_table(){return"supplier"}}const U=Supplier;var L=__nccwpck_require__(322);class SupplierData{static async offline_all_supplier_by_related_id(e){const t={related_id:e,status:L.SC.ONLINE};const a={status:L.SC.OFFLINE};return U.update(a,t)}static async get_list_by_related_id(e){const t={related_id:e,status:L.SC.ONLINE,ORDER:{id:"ASC"}};const a=await U.select(t);if(0===a.length){return[]}return a}static async get_not_deleted_list_by_related_id(e){const t={related_id:e,"status[!=]":L.SC.DELETED,ORDER:{id:"ASC"}};const a=await U.select(t);if(0===a.length){return[]}return a}static async get_one_by_id(e){const t={id:e,ORDER:{id:"ASC"},LIMIT:1};const a=await U.select(t);if(0===a.length){return null}return a[0]}static async get_by_id_list(e){const t={id:e,ORDER:{id:"ASC"}};const a=await U.select(t);if(0===a.length){return[]}return a}static update_supplier_by_id(e,t){const a={id:e};return U.update(t,a)}static get_channel_text(e){let t="";switch(parseInt(e)){case L.r8.GU_FENG:t="古风漫画";break;case L.r8.LIU_MAN_HUA:t="六漫画";break}return t}static get_source_href(e,t){let a="";switch(parseInt(e)){case L.r8.GU_FENG:a=`https://www.gufengmh8.com/manhua/${t}/`;break;case L.r8.LIU_MAN_HUA:a=`http://www.sixmh6.com/${t}/`;break}return a}}class Comic extends N{static get_table(){return"comic"}}const k=Comic;const R={UNKNOWN:0,AUTO:1,AUTO_ONCE:2,MANUAL_TRIGGER:3};const P={DELETED:0,OFFLINE:100,ONLINE:200};class ComicData{static async get_comic_by_id(e){const t={id:e,ORDER:{id:"asc"},LIMIT:1};const a=await k.select(t);if(0===a.length){return null}return a[0]}static update_comic_by_id(e,t){const a={id:e};return k.update(t,a)}static async get_list_available(){const e={status:[P.OFFLINE,P.ONLINE],ORDER:{weight:"DESC"}};const t=await k.select(e);if(0===t.length){return[]}return t}}var D=__nccwpck_require__(971);class SupplierChapter extends N{static get_table(){return"supplier_chapter"}}const q=SupplierChapter;const Z={DELETED:0,WAIT:100,ONLINE:200};class SupplierChapterData{static async get_list_by_related_id(e){const t={related_id:e,status:Z.ONLINE,ORDER:{id:"ASC"}};const a=await q.select(t);if(0===a.length){return[]}return a}static async get_list_by_id_sequence_list(e,t){const a={related_id:e,status:[Z.WAIT,Z.ONLINE],sequence:t,ORDER:{id:"ASC"}};const r=await q.select(a);if(0===r.length){return[]}return r}static async get_chapter_by_id(e){const t={id:e,ORDER:{id:"asc"},LIMIT:1};const a=await q.select(t);if(0===a.length){return null}return a[0]}static async do_insert(e){let t="ON DUPLICATE KEY UPDATE status = VALUES( status )";return q.insert(e,t)}static set_status_ok_by_id(e){const t={id:e};const a={status:Z.ONLINE};return q.update(a,t)}}class ArrayTool{static column(e,t){let a=[];for(let r in e){a.push(e[r][t])}return a}static map_by_key(e,t){let a={};for(let r in e){let s=e[r][t];a[s]=e[r]}return a}}class SupplierImage extends N{static get_table(){return"supplier_image"}}const v=SupplierImage;const W={DELETED:0,ONLINE:200};class SupplierImageData{static async do_insert(e){let t="ON DUPLICATE KEY UPDATE status = VALUES( status )";return v.insert(e,t)}static delete_by_related_id(e){const t={related_id:e};const a={status:W.DELETED};return v.update(a,t)}}var K=__nccwpck_require__(420);var B=__nccwpck_require__(833);const Q=__nccwpck_require__(282);const $=__nccwpck_require__(464);const H=__nccwpck_require__(603);class LiuManHuaService extends K.Z{static async get_base_info(t,a){e.Z.ctxInfo(t,`开始拉取 source_id ${a} 基本信息`);let r=`http://www.sixmh6.com/${a}/`;let s={headers:{"User-Agent":B.Z.fake_one()},timeout:3e3};return $(r,s).then((e=>e.text())).then((r=>{const s=H.load(r);let _=s(".cy_title").find("h1").text();let i=s(".cy_info_cover img").eq(0).attr("src");let n=s(".cy_desc p").eq(0).text().trim("");e.Z.ctxInfo(t,"数据如下",{name:_,pic:i,intro:n});e.Z.ctxInfo(t,`拉取结束 source_id ${a} 基本信息`);return{name:_,pic:i,intro:n}}))}static async get_chapter_list(t,a){let r=this;e.Z.ctxInfo(t,`开始拉取 source_id ${a} 列表信息-头部`);let s=`http://www.sixmh6.com/${a}/`;let _=0;let i=[];let n={headers:{"User-Agent":B.Z.fake_one()},timeout:3e3};await $(s,n).then((e=>e.text())).then((e=>{const t=H.load(e);let a=t(".cy_plist li");let s=a.length;if(s>0){for(let e=0;e<s;e++){let t=a.eq(e);let s=t.find("a").attr("href");s=r.getLink(s);let _=t.find("p").text();let n={link:s,name:_};i.push(n)}}}));e.Z.ctxInfo(t,`开始拉取 source_id ${a} 列表信息-剩余部分`);let l=`http://www.sixmh6.com/bookchapter/`;let o={method:"POST",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`id=${a}&id2=1`};let c=0;await $(l,o).then((e=>e.text())).then((s=>{let n=JSON.parse(s);let l=n.length;for(let e=0;e<l;e++){let t=n[e];let s=r.getLink(`/${a}/${t.chapterid}.html`);let l=t.chaptername;_++;let o={link:s,name:l};i.push(o)}c=i.length;e.Z.ctxInfo(t,`拉取结束 source_id ${a} 总计章节数 ${c}`)}));let u=[];for(let e=0;e<c;e++){let t=c-1-e;let a=e+1;i[t]["sequence"]=a;u.push(i[t])}return u}static getLink(e){return`http://www.sixmh6.com/${e}`}static async get_image_list(t,a){let r=[];e.Z.ctxInfo(t,`开始拉取 ${a} 图片列表`);let s={headers:{"User-Agent":B.Z.fake_one()},timeout:3e3};return $(a,s).then((e=>e.text())).then((r=>{let s=r.match(/eval\((.*)\)/);let _=s[0];let i=`\n                    ${_} \n                    ;module.exports = newImgs\n                `;let n="tmp-runtime-module";const l=new Q(n);l._compile(i,n);let o=l.exports;e.Z.ctxInfo(t,`拉取结束 target_url ${a} 总计图片数 ${o.length}`);return o}))}}class TaskLogic extends Base{static async comic_base(t,a){let r=a.id;let s=a.event;const _=await ComicData.get_comic_by_id(r);if(!_){e.Z.ctxWarn(t,"ID不存在");return m.TASK_SUCCESS}switch(s){case m.EVENT_SUBSCRIBE:const a=await SupplierData.get_list_by_related_id(r);let s=a.length;if(s===0){e.Z.ctxInfo(t,"暂无渠道");break}const _=new RabbitMQ;_.set_exchange(S.AMQP_EXCHANGE_TOPIC);_.set_routing_key(S.AMQP_ROUTING_KEY_SUPPLIER_BASE);_.set_queue(S.AMQP_QUEUE_SUPPLIER_BASE);let i=[];for(let e=0;e<s;e++){let t=a[e];i.push({id:parseInt(t.id)})}await _.push_multi(i);e.Z.ctxInfo(t,`notify ${s} supplier success`);break;case m.EVENT_UNSUBSCRIBE:await SupplierData.offline_all_supplier_by_related_id(r);break;default:e.Z.ctxWarn(t,"event 异常")}return m.TASK_SUCCESS}static async supplier_base(t,a){let r=a.id;const s=await SupplierData.get_one_by_id(r);if(!s){e.Z.ctxWarn(t,"supplier_id 不存在");return}let _={};let i={name:"",pic:"",intro:""};let n,l,o="";switch(s.channel){case L.r8.GU_FENG:i=await D.Z.get_base_info(t,s.source_id);break;case L.r8.QI_MAN_WU:break;case L.r8.LIU_MAN_HUA:i=await LiuManHuaService.get_base_info(t,s.source_id);break;default:e.Z.ctxWarn(t,"channel 异常");return m.TASK_SUCCESS}n=b.Z.get_data_with_default(i.name,"");l=b.Z.get_data_with_default(i.pic,"");o=b.Z.get_data_with_default(i.intro,"");if(n==""&&l==""&&o==""){e.Z.ctxWarn(t,"本次未更新，因为渠道基本信息都是空的");e.Z.ctxWarn(t,i);return m.TASK_SUCCESS}if(n!=s.name||l!=s.pic||o!=s.intro){_.name=n;_.intro=o;_.pic=l;await SupplierData.update_supplier_by_id(r,_)}if(s.related_id>0){let a=s.related_id;const r=await ComicData.get_comic_by_id(a);if(!r){e.Z.ctxWarn(t,"comic_id 不存在");return m.TASK_SUCCESS}if(r.related_id==s.id&&(r.method==R.AUTO||r.method==R.AUTO_ONCE&&r.name=="")){let e={name:n,pic:l,intro:o};await ComicData.update_comic_by_id(a,e)}}return m.TASK_SUCCESS}static async supplier_chapter(t,a){let r=a.id;const s=await SupplierData.get_one_by_id(r);if(!s){e.Z.ctxWarn(t,"supplier_id 不存在");return}let _=[];switch(s.channel){case L.r8.GU_FENG:let a=s.ext_1;_=await D.Z.get_chapter_list(t,s.source_id,a);break;case L.r8.QI_MAN_WU:break;case L.r8.LIU_MAN_HUA:_=await LiuManHuaService.get_chapter_list(t,s.source_id);break;default:e.Z.ctxWarn(t,"channel 异常");return m.TASK_SUCCESS}let i=_.length;let n=i-1;let l=_[n]["sequence"];const o=await SupplierChapterData.get_list_by_related_id(r);let c=this.supplier_chapter_diff(t,o,_);let u=c.length;if(u===0){e.Z.ctxInfo(t,"暂无需要爬取的章节列表信息");return m.TASK_SUCCESS}let p=[];for(let e=0;e<u;e++){let t={related_id:r,sequence:c[e].sequence,name:c[e].name,status:Z.WAIT};p.push(t)}await SupplierChapterData.do_insert(p);let d=ArrayTool.column(p,"sequence");let h=await SupplierChapterData.get_list_by_id_sequence_list(r,d);let E=ArrayTool.map_by_key(h,"sequence");const f=new RabbitMQ;f.set_exchange(S.AMQP_EXCHANGE_TOPIC);f.set_routing_key(S.AMQP_ROUTING_KEY_SUPPLIER_CHAPTER);f.set_queue(S.AMQP_QUEUE_SUPPLIER_CHAPTER_INFO);let g=[];for(let e=0;e<u;e++){let t=c[e];let a=E[t.sequence].id;g.push({id:a,link:t.link})}await f.push_multi(g);let w={max_sequence:l};await SupplierData.update_supplier_by_id(r,w);return m.TASK_SUCCESS}static supplier_chapter_diff(e,t,a){let r=[];let s={};let _=t.length;for(let e=0;e<_;e++){let a=t[e].sequence;s[a]=1}let i=a.length;if(i===0){return r}for(let e=0;e<i;e++){let t=a[e];let _=t.sequence;if(s[_]){continue}let i=JSON.parse(JSON.stringify(t));r.push(i)}return r}static async supplier_image(t,a){let r=a.id;let s=a.link;const _=await SupplierChapterData.get_chapter_by_id(r);if(!_){e.Z.ctxWarn(t,"chapter_id 不存在");return m.TASK_SUCCESS}const i=await SupplierData.get_one_by_id(_.related_id);if(!i){e.Z.ctxWarn(t,"supplier_id 不存在");return}await SupplierImageData.delete_by_related_id(r);let n=[];switch(i.channel){case L.r8.GU_FENG:n=await D.Z.get_image_list(t,s);break;case L.r8.QI_MAN_WU:break;case L.r8.LIU_MAN_HUA:n=await LiuManHuaService.get_image_list(t,s);break;default:e.Z.ctxWarn(t,"channel 异常");return m.TASK_SUCCESS}let l=n.length;if(!l||l===0){return m.TASK_SUCCESS}let o=[];for(let e=0;e<l;e++){o.push({src_origin:n[e],related_id:r,sequence:e+1,status:W.ONLINE})}await SupplierImageData.do_insert(o);e.Z.ctxInfo(t,`one_chapter.id ${_.id}`);await SupplierChapterData.set_status_ok_by_id(_.id);return m.TASK_SUCCESS}static async notify_sub(t,a){let r=[];if(a===undefined){let e=await ComicData.get_list_available();let t=e.length;for(let a=0;a<t;a++){let t={id:parseInt(e[a].id),event:m.EVENT_SUBSCRIBE};r.push(t)}}else{let e={id:parseInt(a),event:m.EVENT_SUBSCRIBE};r.push(e)}let s=r.length;if(s===0){e.Z.ctxWarn(t,"暂无需要通知订阅的漫画");return}const _=new RabbitMQ;_.set_exchange(S.AMQP_EXCHANGE_TOPIC);_.set_routing_key(S.AMQP_ROUTING_KEY_COMIC_BASE);_.set_queue(S.AMQP_QUEUE_COMIC_BASE);await _.push_multi(r);e.Z.ctxInfo(t,`通知订阅成功,总计 ${s} 个`)}}class ComicTask extends BaseTask{static async base_consumer(){const t=new RabbitMQ;t.set_exchange(S.AMQP_EXCHANGE_TOPIC);t.set_routing_key(S.AMQP_ROUTING_KEY_COMIC_BASE);t.set_queue(S.AMQP_QUEUE_COMIC_BASE);t.set_block_second(m.MQ_CONSUMER_BLOCK_SECOND);await t.pull((async t=>{let a=ContextTool.initial();try{e.Z.ctxInfo(a,"base_consumer.start");let r=await TaskLogic.comic_base(a,t);if(r===m.TASK_FAILED){throw new Error("TASK_FAILED")}e.Z.ctxInfo(a,"base_consumer.success  "+JSON.stringify(t));return E}catch(r){e.Z.ctxInfo(a,"base_consumer.payload  "+JSON.stringify(t));e.Z.ctxError(a,"base_consumer.CONSUMER_ERROR  "+r.stack)}return f}))}static async base_supplier_consumer(){let t=this;const a=new RabbitMQ;a.set_exchange(S.AMQP_EXCHANGE_TOPIC);a.set_routing_key(S.AMQP_ROUTING_KEY_SUPPLIER_BASE);a.set_queue(S.AMQP_QUEUE_SUPPLIER_BASE);a.set_block_second(m.MQ_CONSUMER_BLOCK_SECOND);await a.pull((async t=>{let a=ContextTool.initial();try{e.Z.ctxInfo(a,"base_supplier_consumer.start");let r=await TaskLogic.supplier_base(a,t);if(r===m.TASK_FAILED){throw new Error("TASK_FAILED")}e.Z.ctxInfo(a,"base_supplier_consumer.success  "+JSON.stringify(t));return E}catch(r){e.Z.ctxInfo(a,"base_supplier_consumer.payload  "+JSON.stringify(t));e.Z.ctxError(a,"base_supplier_consumer.CONSUMER_ERROR  "+r.stack)}return f}))}static async supplier_chapter_consumer(){const t=new RabbitMQ;t.set_exchange(S.AMQP_EXCHANGE_TOPIC);t.set_routing_key(S.AMQP_ROUTING_KEY_SUPPLIER_BASE);t.set_queue(S.AMQP_QUEUE_SUPPLIER_CHAPTER);t.set_block_second(m.MQ_CONSUMER_BLOCK_SECOND);t.set_pull_timeout(c,d);await t.pull((async t=>{let a=ContextTool.initial();try{e.Z.ctxInfo(a,"supplier_chapter_consumer.start");let r=await TaskLogic.supplier_chapter(a,t);if(r===m.TASK_FAILED){throw new Error("TASK_FAILED")}e.Z.ctxInfo(a,"supplier_chapter_consumer.success  "+JSON.stringify(t));return E}catch(r){e.Z.ctxInfo(a,"supplier_chapter_consumer.payload  "+JSON.stringify(t));e.Z.ctxError(a,"supplier_chapter_consumer.CONSUMER_ERROR  "+r.stack)}return f}))}static async supplier_image_consumer(){const t=new RabbitMQ;t.set_exchange(S.AMQP_EXCHANGE_TOPIC);t.set_routing_key(S.AMQP_ROUTING_KEY_SUPPLIER_CHAPTER);t.set_queue(S.AMQP_QUEUE_SUPPLIER_CHAPTER_INFO);t.set_block_second(m.MQ_CONSUMER_BLOCK_SECOND);await t.pull((async t=>{let a=ContextTool.initial();try{e.Z.ctxInfo(a,"supplier_image_consumer.start");let r=await TaskLogic.supplier_image(a,t);if(r===m.TASK_FAILED){throw new Error("TASK_FAILED")}e.Z.ctxInfo(a,"supplier_image_consumer.success  "+JSON.stringify(t));return E}catch(r){e.Z.ctxInfo(a,"supplier_image_consumer.payload  "+JSON.stringify(t));e.Z.ctxError(a,"supplier_image_consumer.CONSUMER_ERROR  "+r.stack)}return f}))}static async notify_sub_all(){let t=ContextTool.initial();let a=undefined;try{e.Z.ctxInfo(t,"spider_notify_all.start");let r=await TaskLogic.notify_sub(t,a);if(r===m.TASK_FAILED){throw new Error("TASK_FAILED")}e.Z.ctxInfo(t,"spider_notify_all.success  "+a)}catch(r){e.Z.ctxInfo(t,"spider_notify_all.payload  "+a);e.Z.ctxError(t,"spider_notify_all.CONSUMER_ERROR  "+r.stack)}}}const G=new Register;G.bootstrap().use("comic",ComicTask).run()})();module.exports=__webpack_exports__})();